<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Enhanced Privacy Browser Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #ffffff;
      --text: #333;
      --card: #f8f9fa;
      --accent: #007bff;
      --border: #e0e0e0;
      --success: #28a745;
      --warning: #ffc107;
      --danger: #dc3545;
      --info: #17a2b8;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    body.dark {
      --bg: #121212;
      --text: #f0f0f0;
      --card: #1e1e1e;
      --accent: #0d6efd;
      --border: #333;
      --shadow: rgba(255, 255, 255, 0.1);
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, var(--bg) 0%, var(--card) 100%);
      color: var(--text);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 10px;
      line-height: 1.6;
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background-color: var(--card);
      border-radius: 16px;
      box-shadow: 0 8px 32px var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: clamp(1.8rem, 4vw, 2.5rem);
      margin: 0;
      background: linear-gradient(45deg, var(--accent), #6f42c1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 20px;
    }

    button {
      background: linear-gradient(45deg, var(--accent), #0056b3);
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 123, 255, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: linear-gradient(45deg, #6c757d, #5a6268);
    }

    .btn-success {
      background: linear-gradient(45deg, var(--success), #1e7e34);
    }

    .btn-warning {
      background: linear-gradient(45deg, var(--warning), #e0a800);
    }

    .btn-danger {
      background: linear-gradient(45deg, var(--danger), #c82333);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .card {
      background: var(--card);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 4px 15px var(--shadow);
    }

    .card h3 {
      margin: 0 0 15px 0;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background-color: var(--border);
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(45deg, var(--success), var(--info));
      transition: width 0.5s ease;
      border-radius: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 15px var(--shadow);
    }

    th, td {
      border: 1px solid var(--border);
      padding: 12px;
      text-align: left;
    }

    th {
      background: var(--accent);
      color: white;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background-color: var(--border);
    }

    .risk-low { color: var(--success); font-weight: 600; }
    .risk-medium { color: var(--warning); font-weight: 600; }
    .risk-high { color: var(--danger); font-weight: 600; }

    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .status-good { background-color: var(--success); }
    .status-warning { background-color: var(--warning); }
    .status-bad { background-color: var(--danger); }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--border);
      border-radius: 50%;
      border-top-color: var(--accent);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .tooltip {
      position: relative;
      cursor: help;
    }

    .tooltip::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--text);
      color: var(--bg);
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s;
      z-index: 1000;
    }

    .tooltip:hover::after {
      opacity: 1;
    }

    .expandable {
      cursor: pointer;
      user-select: none;
    }

    .expandable::before {
      content: '‚ñ∂ ';
      transition: transform 0.3s;
    }

    .expandable.expanded::before {
      transform: rotate(90deg);
    }

    .collapsible {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .collapsible.expanded {
      max-height: 500px;
    }

    .alert {
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid;
    }

    .alert-info {
      background-color: rgba(23, 162, 184, 0.1);
      border-color: var(--info);
      color: var(--info);
    }

    .alert-warning {
      background-color: rgba(255, 193, 7, 0.1);
      border-color: var(--warning);
      color: #856404;
    }

    .alert-danger {
      background-color: rgba(220, 53, 69, 0.1);
      border-color: var(--danger);
      color: var(--danger);
    }

    canvas {
      max-width: 100%;
      margin-top: 15px;
      border-radius: 8px;
    }

    .monitoring-status {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--card);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 4px 15px var(--shadow);
      border: 1px solid var(--border);
      z-index: 1000;
    }

    .export-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 15px;
        margin: 5px;
        border-radius: 12px;
      }

      .controls {
        flex-direction: column;
        align-items: stretch;
      }

      button {
        padding: 15px;
        font-size: 16px;
      }

      .grid {
        grid-template-columns: 1fr;
      }

      table {
        font-size: 14px;
      }

      th, td {
        padding: 8px;
      }
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="monitoring-status" id="monitoringStatus" style="display: none;">
    <span class="status-indicator status-good"></span>
    Real-time monitoring active
  </div>

  <div class="container">
    <div class="header">
      <h1>üõ°Ô∏è Enhanced Privacy Browser Analyzer</h1>
      <p>Comprehensive privacy and security analysis for your browser</p>
    </div>

    <div class="controls">
      <button onclick="toggleDarkMode()">üåô Toggle Dark Mode</button>
      <button onclick="startAnalysis()" id="analyzeBtn">üîç Start Full Analysis</button>
      <button onclick="toggleMonitoring()" id="monitorBtn">üì° Start Monitoring</button>
      <button onclick="exportData()" class="btn-success">üì§ Export Data</button>
      <button onclick="importData()" class="btn-warning">üì• Import Data</button>
      <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">
    </div>

    <div class="alert alert-info">
      <strong>Privacy Notice:</strong> This tool analyzes your browser locally. No data is sent to external servers. 
      <span class="tooltip" data-tooltip="All analysis happens in your browser. We respect your privacy!">‚ÑπÔ∏è</span>
    </div>
  </div>

  <div id="results" class="container" style="display: none;">
    <div class="grid">
      <div class="card">
        <h3>üìä Privacy Score</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="privacyScore" style="width: 0%"></div>
        </div>
        <p id="scoreText">Calculating...</p>
      </div>

      <div class="card">
        <h3>üéØ Tracking Elements</h3>
        <canvas id="trackingChart" width="300" height="200"></canvas>
      </div>
    </div>

    <div class="container">
      <h2 class="expandable" onclick="toggleSection('cookieSection')">üç™ Cookie Analysis</h2>
      <div id="cookieSection" class="collapsible">
        <table>
          <thead>
            <tr><th>Name</th><th>Domain</th><th>Type</th><th>Risk</th><th>Attributes</th></tr>
          </thead>
          <tbody id="cookiesBody"></tbody>
        </table>
      </div>
    </div>

    <div class="container">
      <h2 class="expandable" onclick="toggleSection('fingerprintSection')">üîç Fingerprinting Analysis</h2>
      <div id="fingerprintSection" class="collapsible">
        <div class="grid">
          <div class="card">
            <h3>Canvas Fingerprinting</h3>
            <p id="canvasResult">Analyzing...</p>
          </div>
          <div class="card">
            <h3>WebGL Fingerprinting</h3>
            <p id="webglResult">Analyzing...</p>
          </div>
          <div class="card">
            <h3>Audio Fingerprinting</h3>
            <p id="audioResult">Analyzing...</p>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <h2 class="expandable" onclick="toggleSection('securitySection')">üîê Security Analysis</h2>
      <div id="securitySection" class="collapsible">
        <table>
          <thead>
            <tr><th>Security Feature</th><th>Status</th><th>Details</th></tr>
          </thead>
          <tbody id="securityBody"></tbody>
        </table>
      </div>
    </div>

    <div class="container">
      <h2 class="expandable" onclick="toggleSection('recommendationsSection')">üí° Personalized Recommendations</h2>
      <div id="recommendationsSection" class="collapsible">
        <div id="recommendations"></div>
      </div>
    </div>

    <div class="export-options">
      <button onclick="generateReport('pdf')" class="btn-secondary">üìÑ Export TXT</button>
      <button onclick="generateReport('csv')" class="btn-secondary">üìä Export CSV</button>
      <button onclick="generateReport('json')" class="btn-secondary">üìã Export JSON</button>
    </div>
  </div>

  <div id="monitoring" class="container" style="display: none;">
    <h2>üì° Real-Time Monitoring</h2>
    <div class="grid">
      <div class="card">
        <h3>Recent Activity</h3>
        <ul id="activityLog"></ul>
      </div>
      <div class="card">
        <h3>Tracking Attempts</h3>
        <canvas id="monitoringChart" width="300" height="200"></canvas>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    // Global variables
    let isMonitoring = false;
    let monitoringInterval;
    let analysisData = {};
    let charts = {};
    
    // Known tracking domains
    const TRACKING_DOMAINS = [
      'google-analytics.com', 'googletagmanager.com', 'doubleclick.net',
      'facebook.com', 'connect.facebook.net', 'amazon-adsystem.com',
      'googlesyndication.com', 'scorecardresearch.com', 'quantserve.com',
      'outbrain.com', 'taboola.com', 'criteo.com', 'adsystem.amazon.com'
    ];

    // Browser detection
    function detectBrowser() {
      const ua = navigator.userAgent;
      if (ua.includes('Chrome') && !ua.includes('Edg')) return 'Chrome';
      if (ua.includes('Firefox')) return 'Firefox';
      if (ua.includes('Safari') && !ua.includes('Chrome')) return 'Safari';
      if (ua.includes('Edg')) return 'Edge';
      return 'Unknown';
    }

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
      const isDark = document.body.classList.contains('dark');
      if (typeof(Storage) !== "undefined") {
        localStorage.setItem('darkMode', isDark);
      }
    }

    function toggleSection(sectionId) {
      const section = document.getElementById(sectionId);
      const header = section.previousElementSibling;
      
      section.classList.toggle('expanded');
      header.classList.toggle('expanded');
    }

    // Enhanced fingerprinting detection
    function analyzeCanvasFingerprinting() {
      try {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Draw test pattern
        ctx.textBaseline = 'top';
        ctx.font = '14px Arial';
        ctx.fillText('Privacy test üîí', 2, 2);
        
        // Add some graphics
        ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
        ctx.fillRect(100, 5, 80, 20);
        
        const fingerprint = canvas.toDataURL();
        const hash = simpleHash(fingerprint);
        
        return {
          detected: true,
          uniqueness: 'Medium',
          hash: hash.substring(0, 8),
          risk: 'Medium'
        };
      } catch (e) {
        return { detected: false, error: e.message, risk: 'Low' };
      }
    }

    function analyzeWebGLFingerprinting() {
      try {
        const canvas = document.createElement('canvas');
        const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
        
        if (!gl) {
          return { detected: false, reason: 'WebGL not supported', risk: 'Low' };
        }

        const renderer = gl.getParameter(gl.RENDERER);
        const vendor = gl.getParameter(gl.VENDOR);
        const version = gl.getParameter(gl.VERSION);
        
        return {
          detected: true,
          renderer: renderer,
          vendor: vendor,
          version: version,
          risk: 'High'
        };
      } catch (e) {
        return { detected: false, error: e.message, risk: 'Low' };
      }
    }

    function analyzeAudioFingerprinting() {
      return new Promise((resolve) => {
        try {
          const audioContext = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioContext.createOscillator();
          const analyser = audioContext.createAnalyser();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(analyser);
          analyser.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = 1000;
          gainNode.gain.value = 0; // Silent
          
          oscillator.start();
          
          setTimeout(() => {
            const frequencyData = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(frequencyData);
            
            const hash = simpleHash(Array.from(frequencyData).join(''));
            
            oscillator.stop();
            audioContext.close();
            
            resolve({
              detected: true,
              hash: hash.substring(0, 8),
              risk: 'High'
            });
          }, 100);
        } catch (e) {
          resolve({ detected: false, error: e.message, risk: 'Low' });
        }
      });
    }

    // Enhanced cookie analysis
    function analyzeCookies() {
      const cookies = document.cookie.split(';').filter(c => c.trim());
      const results = [];
      
      cookies.forEach(cookie => {
        const [name, value] = cookie.split('=').map(s => s.trim());
        const domain = document.domain;
        
        // Determine if third-party
        const isThirdParty = TRACKING_DOMAINS.some(td => domain.includes(td));
        const type = isThirdParty ? 'Third-party' : 'First-party';
        
        // Risk assessment
        let risk = 'Low';
        const sensitiveKeywords = ['session', 'login', 'auth', 'token', 'user', 'track', 'id'];
        const keywordMatches = sensitiveKeywords.filter(k => 
          name.toLowerCase().includes(k)).length;
        
        if (isThirdParty || keywordMatches > 2) risk = 'High';
        else if (keywordMatches > 0) risk = 'Medium';
        
        results.push({
          name: name || 'unnamed',
          domain,
          type,
          risk,
          attributes: 'HttpOnly: Unknown, Secure: Unknown'
        });
      });
      
      return results;
    }

    // Security analysis
    function analyzeSecurityFeatures() {
      const results = [];
      
      // HTTPS check
      results.push({
        feature: 'HTTPS Connection',
        status: location.protocol === 'https:' ? 'Enabled' : 'Disabled',
        details: location.protocol === 'https:' ? 'Connection is encrypted' : 'Connection is not encrypted',
        risk: location.protocol === 'https:' ? 'Low' : 'High'
      });
      
      // Mixed content check
      const hasMixedContent = location.protocol === 'https:' && 
        (document.querySelectorAll('img[src^="http:"], script[src^="http:"], link[href^="http:"]').length > 0);
      
      results.push({
        feature: 'Mixed Content',
        status: hasMixedContent ? 'Detected' : 'None',
        details: hasMixedContent ? 'HTTP resources on HTTPS page detected' : 'All resources served securely',
        risk: hasMixedContent ? 'Medium' : 'Low'
      });
      
      // Content Security Policy
      const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
      results.push({
        feature: 'Content Security Policy',
        status: cspMeta ? 'Enabled' : 'Not Detected',
        details: cspMeta ? 'CSP meta tag found' : 'No CSP protection detected',
        risk: cspMeta ? 'Low' : 'Medium'
      });
      
      // Referrer Policy
      const referrerMeta = document.querySelector('meta[name="referrer"]');
      results.push({
        feature: 'Referrer Policy',
        status: referrerMeta ? 'Configured' : 'Default',
        details: referrerMeta ? `Policy: ${referrerMeta.content}` : 'Using browser default',
        risk: referrerMeta ? 'Low' : 'Medium'
      });
      
      return results;
    }

    // Generate personalized recommendations
    function generateRecommendations(analysisData) {
      const browser = detectBrowser();
      const recommendations = [];
      
      // Browser-specific recommendations
      const browserRecommendations = {
        'Chrome': [
          'Enable "Enhanced protection" in Chrome Privacy settings',
          'Install uBlock Origin extension for ad blocking',
          'Disable third-party cookies in Settings > Privacy > Cookies',
          'Use Chrome\'s built-in password manager with 2FA'
        ],
        'Firefox': [
          'Enable Enhanced Tracking Protection (Strict mode)',
          'Install Firefox Multi-Account Containers',
          'Use Firefox Relay for email masking',
          'Enable DNS over HTTPS in network settings'
        ],
        'Safari': [
          'Enable Intelligent Tracking Prevention',
          'Turn on "Hide IP Address" in Safari settings',
          'Use Safari\'s built-in password suggestions',
          'Enable "Prevent cross-site tracking"'
        ],
        'Edge': [
          'Set tracking prevention to "Strict"',
          'Enable Microsoft Defender SmartScreen',
          'Use InPrivate browsing for sensitive activities',
          'Configure Collections for organized browsing'
        ]
      };

      // Add browser-specific recommendations
      if (browserRecommendations[browser]) {
        recommendations.push({
          category: `${browser} Specific`,
          items: browserRecommendations[browser]
        });
      }

      // Security-based recommendations
      const securityRecs = [];
      if (location.protocol !== 'https:') {
        securityRecs.push('Always use HTTPS websites when possible');
      }
      
      if (analysisData.cookies && analysisData.cookies.some(c => c.type === 'Third-party')) {
        securityRecs.push('Regularly clear third-party cookies');
        securityRecs.push('Consider using a VPN for additional privacy');
      }
      
      if (securityRecs.length > 0) {
        recommendations.push({
          category: 'Security Priorities',
          items: securityRecs
        });
      }

      // Fingerprinting recommendations
      const fingerprintRecs = [];
      if (analysisData.canvas && analysisData.canvas.detected) {
        fingerprintRecs.push('Use browser extensions that block canvas fingerprinting');
      }
      if (analysisData.webgl && analysisData.webgl.detected) {
        fingerprintRecs.push('Consider disabling WebGL in browser settings');
      }
      if (analysisData.audio && analysisData.audio.detected) {
        fingerprintRecs.push('Review browser permissions for audio access');
      }
      
      if (fingerprintRecs.length > 0) {
        recommendations.push({
          category: 'Anti-Fingerprinting',
          items: fingerprintRecs
        });
      }

      return recommendations;
    }

    // Privacy score calculation
    function calculatePrivacyScore(data) {
      let score = 100;
      
      // Deduct for cookies
      if (data.cookies) {
        const thirdPartyCookies = data.cookies.filter(c => c.type === 'Third-party').length;
        score -= Math.min(thirdPartyCookies * 5, 30);
      }
      
      // Deduct for fingerprinting
      if (data.canvas && data.canvas.detected) score -= 15;
      if (data.webgl && data.webgl.detected) score -= 20;
      if (data.audio && data.audio.detected) score -= 20;
      
      // Deduct for security issues
      if (data.security) {
        const highRiskIssues = data.security.filter(s => s.risk === 'High').length;
        score -= highRiskIssues * 10;
      }
      
      return Math.max(score, 0);
    }

    // Start comprehensive analysis
    async function startAnalysis() {
      const btn = document.getElementById('analyzeBtn');
      btn.disabled = true;
      btn.innerHTML = '<span class="loading"></span> Analyzing...';
      
      try {
        // Reset data
        analysisData = {};
        
        // Analyze cookies
        analysisData.cookies = analyzeCookies();
        updateCookieTable(analysisData.cookies);
        
        // Analyze fingerprinting
        analysisData.canvas = analyzeCanvasFingerprinting();
        analysisData.webgl = analyzeWebGLFingerprinting();
        analysisData.audio = await analyzeAudioFingerprinting();
        
        updateFingerprintingResults(analysisData);
        
        // Analyze security
        analysisData.security = analyzeSecurityFeatures();
        updateSecurityTable(analysisData.security);
        
        // Generate recommendations
        const recommendations = generateRecommendations(analysisData);
        updateRecommendations(recommendations);
        
        // Calculate privacy score
        const score = calculatePrivacyScore(analysisData);
        updatePrivacyScore(score);
        
        // Create charts
        createTrackingChart(analysisData);
        
        // Show results
        document.getElementById('results').style.display = 'block';
        
      } catch (error) {
        console.error('Analysis error:', error);
        alert('Analysis failed. Please try again.');
      } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîç Start Full Analysis';
      }
    }

    // Update UI functions
    function updateCookieTable(cookies) {
      const tbody = document.getElementById('cookiesBody');
      tbody.innerHTML = '';
      
      cookies.forEach(cookie => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${cookie.name}</td>
          <td>${cookie.domain}</td>
          <td>${cookie.type}</td>
          <td class="risk-${cookie.risk.toLowerCase()}">${cookie.risk}</td>
          <td>${cookie.attributes}</td>
        `;
      });
    }

    function updateFingerprintingResults(data) {
      // Canvas results
      const canvasEl = document.getElementById('canvasResult');
      if (data.canvas.detected) {
        canvasEl.innerHTML = `
          <span class="status-indicator status-bad"></span>
          <strong>Detected</strong><br>
          Hash: ${data.canvas.hash}<br>
          Risk: <span class="risk-${data.canvas.risk.toLowerCase()}">${data.canvas.risk}</span>
        `;
      } else {
        canvasEl.innerHTML = '<span class="status-indicator status-good"></span><strong>Not Detected</strong>';
      }
      
      // WebGL results
      const webglEl = document.getElementById('webglResult');
      if (data.webgl.detected) {
        webglEl.innerHTML = `
          <span class="status-indicator status-bad"></span>
          <strong>Detected</strong><br>
          Renderer: ${data.webgl.renderer}<br>
          Risk: <span class="risk-${data.webgl.risk.toLowerCase()}">${data.webgl.risk}</span>
        `;
      } else {
        webglEl.innerHTML = '<span class="status-indicator status-good"></span><strong>Not Available</strong>';
      }
      
      // Audio results
      const audioEl = document.getElementById('audioResult');
      if (data.audio.detected) {
        audioEl.innerHTML = `
          <span class="status-indicator status-bad"></span>
          <strong>Detected</strong><br>
          Hash: ${data.audio.hash}<br>
          Risk: <span class="risk-${data.audio.risk.toLowerCase()}">${data.audio.risk}</span>
        `;
      } else {
        audioEl.innerHTML = '<span class="status-indicator status-good"></span><strong>Not Detected</strong>';
      }
    }

    function updateSecurityTable(security) {
      const tbody = document.getElementById('securityBody');
      tbody.innerHTML = '';
      
      security.forEach(item => {
        const row = tbody.insertRow();
        const statusClass = item.risk === 'Low' ? 'status-good' : 
                          item.risk === 'Medium' ? 'status-warning' : 'status-bad';
        
        row.innerHTML = `
          <td>${item.feature}</td>
          <td><span class="status-indicator ${statusClass}"></span>${item.status}</td>
          <td>${item.details}</td>
        `;
      });
    }

    function updateRecommendations(recommendations) {
      const container = document.getElementById('recommendations');
      container.innerHTML = '';
      
      recommendations.forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'card';
        categoryDiv.innerHTML = `
          <h3>${category.category}</h3>
          <ul>
            ${category.items.map(item => `<li>${item}</li>`).join('')}
          </ul>
        `;
        container.appendChild(categoryDiv);
      });
    }

    function updatePrivacyScore(score) {
      const fill = document.getElementById('privacyScore');
      const text = document.getElementById('scoreText');
      
      fill.style.width = score + '%';
      
      let status = 'Excellent';
      let color = 'var(--success)';
      
      if (score < 70) {
        status = 'Poor';
        color = 'var(--danger)';
      } else if (score < 85) {
        status = 'Good';
        color = 'var(--warning)';
      }
      
      fill.style.background = `linear-gradient(45deg, ${color}, ${color}dd)`;
      text.innerHTML = `Privacy Score: ${score}/100 - ${status}`;
    }

    function createTrackingChart(data) {
      const ctx = document.getElementById('trackingChart').getContext('2d');
      
      if (charts.tracking) {
        charts.tracking.destroy();
      }

      const trackingData = {
        cookies: data.cookies ? data.cookies.length : 0,
        thirdParty: data.cookies ? data.cookies.filter(c => c.type === 'Third-party').length : 0,
        fingerprinting: [data.canvas, data.webgl, data.audio].filter(f => f && f.detected).length,
        localStorage: localStorage.length,
        sessionStorage: sessionStorage.length
      };

      charts.tracking = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['First-party Cookies', 'Third-party Cookies', 'Fingerprinting', 'Local Storage', 'Session Storage'],
          datasets: [{
            data: [
              trackingData.cookies - trackingData.thirdParty,
              trackingData.thirdParty,
              trackingData.fingerprinting,
              trackingData.localStorage,
              trackingData.sessionStorage
            ],
            backgroundColor: [
              '#28a745',
              '#dc3545',
              '#fd7e14',
              '#ffc107',
              '#17a2b8'
            ],
            borderWidth: 2,
            borderColor: 'var(--bg)'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: 'var(--text)',
                usePointStyle: true,
                padding: 15
              }
            }
          }
        }
      });
    }

    // Real-time monitoring
    function toggleMonitoring() {
      const btn = document.getElementById('monitorBtn');
      const status = document.getElementById('monitoringStatus');
      
      if (!isMonitoring) {
        isMonitoring = true;
        btn.innerHTML = '‚èπÔ∏è Stop Monitoring';
        btn.className = 'btn-danger';
        status.style.display = 'block';
        document.getElementById('monitoring').style.display = 'block';
        
        startRealTimeMonitoring();
      } else {
        isMonitoring = false;
        btn.innerHTML = 'üì° Start Monitoring';
        btn.className = '';
        status.style.display = 'none';
        
        if (monitoringInterval) {
          clearInterval(monitoringInterval);
        }
      }
    }

    function startRealTimeMonitoring() {
      const activityLog = document.getElementById('activityLog');
      const monitoringData = {
        timestamps: [],
        cookieChanges: [],
        storageChanges: []
      };

      let lastCookieCount = document.cookie.split(';').filter(c => c.trim()).length;
      let lastLocalStorage = localStorage.length;
      let lastSessionStorage = sessionStorage.length;

      monitoringInterval = setInterval(() => {
        const now = new Date();
        const currentCookies = document.cookie.split(';').filter(c => c.trim()).length;
        const currentLocal = localStorage.length;
        const currentSession = sessionStorage.length;

        // Check for changes
        if (currentCookies !== lastCookieCount) {
          const change = currentCookies - lastCookieCount;
          logActivity(`Cookies ${change > 0 ? 'added' : 'removed'}: ${Math.abs(change)}`, now);
          lastCookieCount = currentCookies;
        }

        if (currentLocal !== lastLocalStorage) {
          const change = currentLocal - lastLocalStorage;
          logActivity(`LocalStorage ${change > 0 ? 'items added' : 'items removed'}: ${Math.abs(change)}`, now);
          lastLocalStorage = currentLocal;
        }

        if (currentSession !== lastSessionStorage) {
          const change = currentSession - lastSessionStorage;
          logActivity(`SessionStorage ${change > 0 ? 'items added' : 'items removed'}: ${Math.abs(change)}`, now);
          lastSessionStorage = currentSession;
        }

        // Update monitoring chart
        monitoringData.timestamps.push(now.toLocaleTimeString());
        monitoringData.cookieChanges.push(currentCookies);
        monitoringData.storageChanges.push(currentLocal + currentSession);

        // Keep only last 20 data points
        if (monitoringData.timestamps.length > 20) {
          monitoringData.timestamps.shift();
          monitoringData.cookieChanges.shift();
          monitoringData.storageChanges.shift();
        }

        updateMonitoringChart(monitoringData);
      }, 2000);
    }

    function logActivity(message, timestamp) {
      const activityLog = document.getElementById('activityLog');
      const li = document.createElement('li');
      li.innerHTML = `<strong>${timestamp.toLocaleTimeString()}</strong>: ${message}`;
      activityLog.insertBefore(li, activityLog.firstChild);

      // Keep only last 10 activities
      while (activityLog.children.length > 10) {
        activityLog.removeChild(activityLog.lastChild);
      }
    }

    function updateMonitoringChart(data) {
      const ctx = document.getElementById('monitoringChart').getContext('2d');
      
      if (charts.monitoring) {
        charts.monitoring.destroy();
      }

      charts.monitoring = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.timestamps,
          datasets: [
            {
              label: 'Cookies',
              data: data.cookieChanges,
              borderColor: '#007bff',
              backgroundColor: 'rgba(0, 123, 255, 0.1)',
              tension: 0.4
            },
            {
              label: 'Storage Items',
              data: data.storageChanges,
              borderColor: '#28a745',
              backgroundColor: 'rgba(40, 167, 69, 0.1)',
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          interaction: {
            intersect: false,
          },
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'Time'
              }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: 'Count'
              }
            }
          },
          plugins: {
            legend: {
              labels: {
                color: 'var(--text)'
              }
            }
          }
        }
      });
    }

    // Data export/import functions
    function exportData() {
      const exportData = {
        timestamp: new Date().toISOString(),
        analysisData: analysisData,
        browserInfo: {
          userAgent: navigator.userAgent,
          platform: navigator.platform,
          language: navigator.language,
          cookieEnabled: navigator.cookieEnabled,
          onLine: navigator.onLine
        },
        url: window.location.href
      };

      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `privacy_analysis_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function importData() {
      document.getElementById('importFile').click();
    }

    function handleImport(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedData = JSON.parse(e.target.result);
          
          if (importedData.analysisData) {
            analysisData = importedData.analysisData;
            
            // Update UI with imported data
            if (analysisData.cookies) updateCookieTable(analysisData.cookies);
            if (analysisData.canvas || analysisData.webgl || analysisData.audio) {
              updateFingerprintingResults(analysisData);
            }
            if (analysisData.security) updateSecurityTable(analysisData.security);
            
            const score = calculatePrivacyScore(analysisData);
            updatePrivacyScore(score);
            
            createTrackingChart(analysisData);
            
            const recommendations = generateRecommendations(analysisData);
            updateRecommendations(recommendations);
            
            document.getElementById('results').style.display = 'block';
            
            alert('Data imported successfully!');
          }
        } catch (error) {
          alert('Error importing data: ' + error.message);
        }
      };
      reader.readAsText(file);
    }

    // Report generation
    function generateReport(format) {
      if (!analysisData || Object.keys(analysisData).length === 0) {
        alert('Please run an analysis first!');
        return;
      }

      switch (format) {
        case 'pdf':
          generatePDFReport();
          break;
        case 'csv':
          generateCSVReport();
          break;
        case 'json':
          generateJSONReport();
          break;
      }
    }

    function generatePDFReport() {
      // Create a comprehensive text report for PDF conversion
      const score = calculatePrivacyScore(analysisData);
      const reportContent = `
PRIVACY ANALYSIS REPORT
=======================
Generated: ${new Date().toLocaleString()}
Website: ${window.location.href}
Browser: ${detectBrowser()}
Privacy Score: ${score}/100

COOKIE ANALYSIS
===============
Total Cookies: ${analysisData.cookies ? analysisData.cookies.length : 0}
Third-party Cookies: ${analysisData.cookies ? analysisData.cookies.filter(c => c.type === 'Third-party').length : 0}

${analysisData.cookies ? analysisData.cookies.map(c => 
  `- ${c.name} (${c.domain}) - ${c.type} - Risk: ${c.risk}`
).join('\n') : 'No cookies analyzed'}

FINGERPRINTING ANALYSIS
=======================
Canvas Fingerprinting: ${analysisData.canvas ? (analysisData.canvas.detected ? 'DETECTED' : 'Not detected') : 'Not analyzed'}
WebGL Fingerprinting: ${analysisData.webgl ? (analysisData.webgl.detected ? 'DETECTED' : 'Not detected') : 'Not analyzed'}
Audio Fingerprinting: ${analysisData.audio ? (analysisData.audio.detected ? 'DETECTED' : 'Not detected') : 'Not analyzed'}

SECURITY ANALYSIS
=================
${analysisData.security ? analysisData.security.map(s => 
  `${s.feature}: ${s.status} - ${s.details}`
).join('\n') : 'No security analysis performed'}

RECOMMENDATIONS
===============
- Use privacy-focused browser extensions
- Regularly clear cookies and browsing data
- Enable strict tracking protection
- Consider using a VPN for additional privacy
- Keep your browser updated
      `;

      const blob = new Blob([reportContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `privacy_report_${new Date().toISOString().split('T')[0]}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function generateCSVReport() {
      if (!analysisData.cookies) {
        alert('No cookie data available for CSV export');
        return;
      }

      const csvContent = [
        ['Name', 'Domain', 'Type', 'Risk', 'Attributes'],
        ...analysisData.cookies.map(c => [c.name, c.domain, c.type, c.risk, c.attributes])
      ].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `privacy_cookies_${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function generateJSONReport() {
      const reportData = {
        metadata: {
          timestamp: new Date().toISOString(),
          url: window.location.href,
          browser: detectBrowser(),
          privacyScore: calculatePrivacyScore(analysisData)
        },
        analysis: analysisData,
        recommendations: generateRecommendations(analysisData)
      };

      const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `privacy_analysis_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Utility functions
    function simpleHash(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        const char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // Convert to 32-bit integer
      }
      return Math.abs(hash).toString(16);
    }

    // Initialize app
    function initializeApp() {
      // Load dark mode preference
      if (typeof(Storage) !== "undefined") {
        const darkMode = localStorage.getItem('darkMode');
        if (darkMode === 'true') {
          document.body.classList.add('dark');
        }
      }

      // Add keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case 'Enter':
              e.preventDefault();
              startAnalysis();
              break;
            case 'd':
              e.preventDefault();
              toggleDarkMode();
              break;
            case 'e':
              e.preventDefault();
              exportData();
              break;
          }
        }
      });

      // Auto-expand first section
      setTimeout(() => {
        const firstSection = document.querySelector('.expandable');
        if (firstSection) {
          firstSection.click();
        }
      }, 500);
    }

    // Start the application
    document.addEventListener('DOMContentLoaded', initializeApp);

    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
      if (monitoringInterval) {
        clearInterval(monitoringInterval);
      }
      Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
      });
    });
  </script>
</body>
</html>
